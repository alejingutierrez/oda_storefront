// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
}

model Brand {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  siteUrl        String?
  category       String?
  productCategory String?
  market         String?
  style          String?
  scale          String?
  avgPrice       Decimal? @db.Decimal(12, 2)
  reviewed       String?
  ratingStars    String?
  ratingScore    Int?
  sourceSheet    String?
  sourceFile     String?
  description    String?
  logoUrl        String?
  contactPhone   String?
  contactEmail   String?
  instagram      String?
  tiktok         String?
  facebook       String?
  whatsapp       String?
  address        String?
  city           String?
  lat            Decimal?
  lng            Decimal?
  openingHours   Json?
  metadata       Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  stores         Store[]
  products       Product[]
  announcements  Announcement[]
  events         Event[]
  assets         Asset[]

  @@index([name])
  @@map("brands")
}

model Store {
  id        String   @id @default(uuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  name      String
  address   String?
  lat       Decimal?
  lng       Decimal?
  phone     String?
  schedule  Json?
  website   String?
  channels  Json?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  assets    Asset[]

  @@index([brandId])
  @@map("stores")
}

model Product {
  id                String    @id @default(uuid())
  brandId           String
  brand             Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  externalId        String?   // id en la tienda origen
  name              String
  description       String?
  category          String?
  subcategory       String?
  styleTags         String[]
  materialTags      String[]
  patternTags       String[]
  occasionTags      String[]
  gender            String?
  season            String?
  care              String?
  origin            String?
  status            String?   // active, archived, etc.
  sourceUrl         String?
  imageCoverUrl     String?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  variants          Variant[]
  assets            Asset[]
  events            Event[]

  @@index([brandId])
  @@index([externalId])
  @@map("products")
}

model Variant {
  id           String    @id @default(uuid())
  productId    String
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku          String?
  color        String?
  size         String?
  fit          String?
  material     String?
  price        Decimal   @db.Decimal(12, 2)
  currency     String    @default("COP")
  stock        Int?      // cantidad num√©rica si aplica
  stockStatus  String?   // in_stock, out_of_stock, preorder, etc.
  images       String[]
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  priceHistory PriceHistory[]
  stockHistory StockHistory[]
  assets       Asset[]
  events       Event[]

  @@index([productId])
  @@unique([productId, sku])
  @@map("variants")
}

model PriceHistory {
  id         String   @id @default(uuid())
  variantId  String
  variant    Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  price      Decimal  @db.Decimal(12, 2)
  currency   String   @default("COP")
  capturedAt DateTime @default(now())

  @@index([variantId])
  @@map("price_history")
}

model StockHistory {
  id         String   @id @default(uuid())
  variantId  String
  variant    Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  stock      Int?
  capturedAt DateTime @default(now())

  @@index([variantId])
  @@map("stock_history")
}

model Asset {
  id         String   @id @default(uuid())
  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  variant    Variant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  storeId    String?
  store      Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  url        String
  blobPath   String?
  kind       String?  // image|video|doc|thumb|caption
  createdAt  DateTime @default(now())
  metadata   Json?

  @@index([productId])
  @@index([variantId])
  @@index([brandId])
  @@index([storeId])
  @@index([userId])
  @@map("assets")
}

model TaxonomyTag {
  id        String   @id @default(uuid())
  type      String
  value     String
  synonyms  String[]
  createdAt DateTime @default(now())

  @@unique([type, value])
  @@index([type])
  @@map("taxonomy_tags")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  role        String   @default("user")
  plan        String   @default("free")
  passwordHash String?
  sessionTokenHash String?
  sessionTokenCreatedAt DateTime?
  lastLoginAt DateTime?
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  events      Event[]
  assets      Asset[]

  @@map("users")
}

model Event {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId  String?
  variant    Variant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  sessionId  String?
  type       String
  payload    Json?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([brandId])
  @@index([productId])
  @@index([variantId])
  @@index([sessionId])
  @@map("events")
}

model Announcement {
  id         String   @id @default(uuid())
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  slot       String
  title      String?
  body       String?
  mediaUrl   String?
  linkUrl    String?
  startsAt   DateTime?
  endsAt     DateTime?
  budget     Decimal? @db.Decimal(12, 2)
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([brandId])
  @@index([slot])
  @@map("announcements")
}
