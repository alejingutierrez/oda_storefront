// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
}

model Brand {
  id             String   @id @default(uuid())
  name           String
  slug           String   @unique
  siteUrl        String?
  category       String?
  productCategory String?
  market         String?
  style          String?
  scale          String?
  avgPrice       Decimal? @db.Decimal(12, 2)
  ecommercePlatform String?
  manualReview   Boolean  @default(false)
  reviewed       String?
  ratingStars    String?
  ratingScore    Int?
  sourceSheet    String?
  sourceFile     String?
  description    String?
  logoUrl        String?
  contactPhone   String?
  contactEmail   String?
  instagram      String?
  tiktok         String?
  facebook       String?
  whatsapp       String?
  address        String?
  city           String?
  lat            Decimal?
  lng            Decimal?
  openingHours   Json?
  metadata       Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  stores         Store[]
  products       Product[]
  announcements  Announcement[]
  events         Event[]
  assets         Asset[]
  scrapeJobs     BrandScrapeJob[]
  catalogRuns    CatalogRun[]
  productEnrichmentRuns ProductEnrichmentRun[]

  @@index([name])
  @@map("brands")
}

model CatalogRun {
  id                String      @id @default(uuid())
  brandId           String
  brand             Brand       @relation(fields: [brandId], references: [id], onDelete: Cascade)
  status            String      @default("processing") // processing | paused | stopped | blocked | completed
  platform          String?
  totalItems        Int         @default(0)
  startedAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  finishedAt        DateTime?
  lastError         String?
  blockReason       String?
  lastUrl           String?
  lastStage         String?
  consecutiveErrors Int         @default(0)
  errorSamples      Json?
  items             CatalogItem[]

  @@index([brandId, status])
  @@map("catalog_runs")
}

model CatalogItem {
  id          String    @id @default(uuid())
  runId       String
  run         CatalogRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  url         String
  status      String    @default("pending") // pending | queued | in_progress | completed | failed
  attempts    Int       @default(0)
  lastError   String?
  lastStage   String?
  startedAt   DateTime?
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@unique([runId, url])
  @@index([runId, status])
  @@map("catalog_items")
}

model BrandScrapeJob {
  id         String   @id @default(uuid())
  brandId    String
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  status     String   @default("queued") // queued | processing | completed | failed
  batchId    String?
  attempts   Int      @default(0)
  lastError  String?
  startedAt  DateTime?
  finishedAt DateTime?
  result     Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([brandId])
  @@index([status, createdAt])
  @@index([batchId])
  @@map("brand_scrape_jobs")
}

model Store {
  id        String   @id @default(uuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  name      String
  address   String?
  lat       Decimal?
  lng       Decimal?
  phone     String?
  schedule  Json?
  website   String?
  channels  Json?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  assets    Asset[]

  @@index([brandId])
  @@map("stores")
}

model Product {
  id                String    @id @default(uuid())
  brandId           String
  brand             Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  externalId        String?   // id en la tienda origen
  name              String
  description       String?
  category          String?
  subcategory       String?
  styleTags         String[]
  materialTags      String[]
  patternTags       String[]
  occasionTags      String[]
  gender            String?
  season            String?
  care              String?
  origin            String?
  status            String?   // active, archived, etc.
  seoTitle          String?
  seoDescription    String?
  seoTags           String[]  @default([])
  currency          String?   // COP, USD, etc.
  sourceUrl         String?
  imageCoverUrl     String?
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  variants          Variant[]
  assets            Asset[]
  events            Event[]
  enrichmentItems   ProductEnrichmentItem[]

  @@index([brandId])
  @@index([externalId])
  @@map("products")
}

model Variant {
  id           String    @id @default(uuid())
  productId    String
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku          String?
  color        String?
  colorPantone String?
  size         String?
  fit          String?
  material     String?
  price        Decimal   @db.Decimal(12, 2)
  currency     String    @default("COP")
  stock        Int?      // cantidad num√©rica si aplica
  stockStatus  String?   // in_stock, out_of_stock, preorder, etc.
  images       String[]
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  priceHistory PriceHistory[]
  stockHistory StockHistory[]
  assets       Asset[]
  events       Event[]
  colorVectors VariantColorVector[]
  colorMatches VariantColorCombinationMatch[]

  @@index([productId])
  @@unique([productId, sku])
  @@map("variants")
}

model ProductEnrichmentRun {
  id                String    @id @default(uuid())
  scope             String
  brandId           String?
  brand             Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  status            String    @default("processing") // processing | paused | stopped | completed | blocked
  totalItems        Int       @default(0)
  startedAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  finishedAt        DateTime?
  lastError         String?
  blockReason       String?
  lastProductId     String?
  lastStage         String?
  consecutiveErrors Int       @default(0)
  metadata          Json?
  items             ProductEnrichmentItem[]

  @@index([brandId, status])
  @@index([scope, status])
  @@map("product_enrichment_runs")
}

model ProductEnrichmentItem {
  id          String    @id @default(uuid())
  runId       String
  run         ProductEnrichmentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  productId   String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  status      String    @default("pending") // pending | queued | in_progress | completed | failed
  attempts    Int       @default(0)
  lastError   String?
  lastStage   String?
  startedAt   DateTime?
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@unique([runId, productId])
  @@index([runId, status])
  @@index([productId])
  @@map("product_enrichment_items")
}

model PriceHistory {
  id         String   @id @default(uuid())
  variantId  String
  variant    Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  price      Decimal  @db.Decimal(12, 2)
  currency   String   @default("COP")
  capturedAt DateTime @default(now())

  @@index([variantId])
  @@map("price_history")
}

model StockHistory {
  id         String   @id @default(uuid())
  variantId  String
  variant    Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  stock      Int?
  capturedAt DateTime @default(now())

  @@index([variantId])
  @@map("stock_history")
}

model Asset {
  id         String   @id @default(uuid())
  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  variant    Variant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  storeId    String?
  store      Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  url        String
  blobPath   String?
  kind       String?  // image|video|doc|thumb|caption
  createdAt  DateTime @default(now())
  metadata   Json?

  @@index([productId])
  @@index([variantId])
  @@index([brandId])
  @@index([storeId])
  @@index([userId])
  @@map("assets")
}

model TaxonomyTag {
  id        String   @id @default(uuid())
  type      String
  value     String
  synonyms  String[]
  createdAt DateTime @default(now())

  @@unique([type, value])
  @@index([type])
  @@map("taxonomy_tags")
}

model ColorCombination {
  id             String   @id @default(uuid())
  imageFilename  String
  detectedLayout String
  comboKey       String
  season         String?
  temperature    String?
  contrast       String?
  mood           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  colors         ColorCombinationColor[]
  variantMatches VariantColorCombinationMatch[]

  @@unique([imageFilename, comboKey])
  @@index([detectedLayout])
  @@index([season])
  @@index([temperature])
  @@map("color_combinations")
}

model ColorCombinationColor {
  id            String           @id @default(uuid())
  combinationId String
  combination   ColorCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)
  position      Int
  role          String?
  hex           String
  pantoneCode   String?
  pantoneName   String?
  labL          Float?
  labA          Float?
  labB          Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([combinationId, position])
  @@index([combinationId])
  @@index([hex])
  @@index([pantoneCode])
  @@map("color_combination_colors")
}

model VariantColorVector {
  id        String   @id @default(uuid())
  variantId String
  variant   Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  position  Int
  hex       String
  labL      Float
  labA      Float
  labB      Float
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId, position])
  @@index([variantId])
  @@map("variant_color_vectors")
}

model VariantColorCombinationMatch {
  id               String           @id @default(uuid())
  variantId        String
  variant          Variant          @relation(fields: [variantId], references: [id], onDelete: Cascade)
  combinationId    String
  combination      ColorCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)
  score            Float
  coverage         Float
  avgDistance      Float
  maxDistance      Float
  matchedColors    Int
  totalComboColors Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([variantId, combinationId])
  @@index([variantId])
  @@index([combinationId])
  @@map("variant_color_combination_matches")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  role        String   @default("user")
  plan        String   @default("free")
  passwordHash String?
  sessionTokenHash String?
  sessionTokenCreatedAt DateTime?
  lastLoginAt DateTime?
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  events      Event[]
  assets      Asset[]

  @@map("users")
}

model Event {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId  String?
  variant    Variant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  sessionId  String?
  type       String
  payload    Json?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([brandId])
  @@index([productId])
  @@index([variantId])
  @@index([sessionId])
  @@map("events")
}

model Announcement {
  id         String   @id @default(uuid())
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  slot       String
  title      String?
  body       String?
  mediaUrl   String?
  linkUrl    String?
  startsAt   DateTime?
  endsAt     DateTime?
  budget     Decimal? @db.Decimal(12, 2)
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([brandId])
  @@index([slot])
  @@map("announcements")
}
